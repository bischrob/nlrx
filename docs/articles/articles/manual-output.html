<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capturing NetLogo output manually • nlrx | NetLogo from R</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Capturing NetLogo output manually">
<meta property="og:description" content="nlrx">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">nlrx | NetLogo from R</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/getstarted.html">
    <span class="fa fa fa fa-magic"></span>
     
    Get Started
  </a>
</li>
<li>
  <a href="../../articles/furthernotes.html">
    <span class="fa fa-book"></span>
     
    Advanced configuration
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-graduation-cap"></span>
     
    More
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/spatial-output.html">
        <span class="fa fa-book"></span>
         
        Capturing spatial NetLogo output
      </a>
    </li>
    <li>
      <a href="../../articles/articles/manual-output.html">
        <span class="fa fa-book"></span>
         
        Capturing NetLogo output manually
      </a>
    </li>
    <li>
      <a href="../../articles/sensitivity.html">
        <span class="fa fa-wrench"></span>
         
        Sensitivity Analysis with nlrx
      </a>
    </li>
    <li>
      <a href="../../articles/optimization.html">
        <span class="fa fa-wrench"></span>
         
        Optimization with nlrx
      </a>
    </li>
    <li>
      <a href="../../articles/abc.html">
        <span class="fa fa-wrench"></span>
         
        Approximate Bayesian Computation (ABC) with nlrx
      </a>
    </li>
    <li>
      <a href="../../articles/simdesign-examples.html">
        <span class="fa fa-wrench"></span>
         
        Simdesign examples
      </a>
    </li>
    <li>
      <a href="../../articles/articles/interfacing-different-models.html">
        <span class="fa fa-wrench"></span>
         
        Interfacing a variety of different NetLogo models
      </a>
    </li>
    <li>
      <a href="../../articles/articles/nlrx_nldoc.html">
        <span class="fa fa-wrench"></span>
         
        NetLogo documentation with nlrx
      </a>
    </li>
    <li>
      <a href="../../articles/articles/nlrx_papers.html">
        <span class="fa fa-bookmark"></span>
         
        Publication record
      </a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../../news/index.html">
    <span class="fa fa-newspaper"></span>
     
    news
  </a>
</li>
<li>
  <a href="../../reference/index.html">
    <span class="fa fa-cogs"></span>
     
    functions
  </a>
</li>
<li>
  <a href="https://github.com/ropensci/nlrx">
    <span class="fa fa-github"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="manual-output_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Capturing NetLogo output manually</h1>
                        <h4 class="author">Jan Salecker</h4>
            
            <h4 class="date">2021-01-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/nlrx/blob/master/vignettes/articles/manual-output.Rmd"><code>vignettes/articles/manual-output.Rmd</code></a></small>
      <div class="hidden name"><code>manual-output.Rmd</code></div>

    </div>

    
    
<div id="capturing-output-manually" class="section level2">
<h2 class="hasAnchor">
<a href="#capturing-output-manually" class="anchor"></a>Capturing output manually</h2>
<p>While nlrx provides the <code>metrics</code>, <code>metrics.turtles</code>, <code>metrics.patches</code> and <code>metrics.links</code> slots of the <code>exerpiment</code> class to capture global and agent related output from NetLogo models, this might not be sufficient under certain circumstances. For example, the <code>metrics</code> slot cannot track and collect nested list output or similar complex data structures such as NetLogo arrays or matrices. Another example would be spatial output such as shapefiles or grids, generated with the GIS extension. Additionally, you might already have implemented complex routines in your model which write model output to disk.</p>
<p>The main question for this vignette to answer is: How can you link such self-written output to your nlrx experiment. Here we show you one basic example how this works. In this example we write ascii raster files using the GIS extension in NetLogo. However, the same workflow can of course be applied to other types of output, for example text files written with <code>file-type</code> primitives or the csv extension.</p>
<div id="step-1-creating-an-id-widget-on-your-model-interface" class="section level4">
<h4 class="hasAnchor">
<a href="#step-1-creating-an-id-widget-on-your-model-interface" class="anchor"></a>Step 1: Creating an ID widget on your model interface</h4>
<p>In order to link self-written output to our nlrx simulations within the R session, we need to transfer the current nlrx siminputrow and seed to our NetLogo model. That way, when executing <code><a href="../../reference/run_nl_all.html">run_nl_all()</a></code>, within each simulation the NetLogo model exactly “knows” which parameter row (siminputrow) is currently simulated and the correpsonding random seed. To transfer this information we just need to create a string input widget on our model interface. In the example below, we created such a widget at the bottom of the Wolf Sheep model called <code>nlrx_id</code>.</p>
<center>
<img src="idrunnum_gui.PNG" align="center" width="75%">
</center>
</div>
<div id="step-2-define-idrunnum-of-the-experiment" class="section level4">
<h4 class="hasAnchor">
<a href="#step-2-define-idrunnum-of-the-experiment" class="anchor"></a>Step 2: Define idrunnum of the experiment</h4>
<p>The idrunnum field of the experiment is a built-in feature that allows to transfer the current experiment name, siminputrow and random seed to a defined NetLogo gui parameter widget. In our case we want to use our newly created <code>nlrx_id</code> string input field, so we just set <code>idrunnum = nlrx_id</code>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># Attach experiment</span>
<span class="no">nl</span>@<span class="kw">experiment</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/experiment.html">experiment</a></span>(<span class="kw">expname</span><span class="kw">=</span><span class="st">"wolf-sheep"</span>,
                            <span class="kw">outpath</span><span class="kw">=</span><span class="no">outpath</span>,
                            <span class="kw">repetition</span><span class="kw">=</span><span class="fl">1</span>,
                            <span class="kw">tickmetrics</span><span class="kw">=</span><span class="st">"true"</span>,
                            <span class="kw">idsetup</span><span class="kw">=</span><span class="st">"setup"</span>,
                            <span class="kw">idgo</span><span class="kw">=</span><span class="st">"go"</span>,
                            <span class="kw">idrunnum</span><span class="kw">=</span><span class="st">"nlrx_id"</span>,
                            <span class="kw">runtime</span><span class="kw">=</span><span class="fl">50</span>,
                            <span class="kw">evalticks</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">40</span>,<span class="fl">50</span>),
                            <span class="kw">metrics</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"count sheep"</span>),
                            <span class="kw">variables</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">'initial-number-sheep'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">min</span><span class="kw">=</span><span class="fl">50</span>, <span class="kw">max</span><span class="kw">=</span><span class="fl">150</span>, <span class="kw">qfun</span><span class="kw">=</span><span class="st">"qunif"</span>),
                                             <span class="st">'initial-number-wolves'</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">min</span><span class="kw">=</span><span class="fl">50</span>, <span class="kw">max</span><span class="kw">=</span><span class="fl">150</span>, <span class="kw">qfun</span><span class="kw">=</span><span class="st">"qunif"</span>)),
                            <span class="kw">constants</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"model-version"</span> <span class="kw">=</span> <span class="st">"\"sheep-wolves-grass\""</span>,
                                             <span class="st">"grass-regrowth-time"</span> <span class="kw">=</span> <span class="fl">30</span>,
                                             <span class="st">"sheep-gain-from-food"</span> <span class="kw">=</span> <span class="fl">4</span>,
                                             <span class="st">"wolf-gain-from-food"</span> <span class="kw">=</span> <span class="fl">20</span>,
                                             <span class="st">"sheep-reproduce"</span> <span class="kw">=</span> <span class="fl">4</span>,
                                             <span class="st">"wolf-reproduce"</span> <span class="kw">=</span> <span class="fl">5</span>,
                                             <span class="st">"show-energy?"</span> <span class="kw">=</span> <span class="st">"false"</span>))</pre></body></html></div>
</div>
<div id="step-3-use-nlrx_id-within-netlogo-model-to-tag-self-written-output" class="section level4">
<h4 class="hasAnchor">
<a href="#step-3-use-nlrx_id-within-netlogo-model-to-tag-self-written-output" class="anchor"></a>Step 3: Use nlrx_id within NetLogo model to tag self-written output</h4>
<p>We can now use the <code>nlrx_id</code> field within the NetLogo model to tag our self-written output. One way to do this is to tag the filenames of self-written output. Here is an example where raster grids are created and written at the end of each model run:</p>
<pre class="netlogo"><code>to write_final_landscape
  let filename (word nlrx_id "_" but-first (word (1000 + ticks)) ".asc")
  if (file-exists? filename) [file-delete filename]
  gis:store-dataset final_landscape filename  
end</code></pre>
<p>Here, we first create our filename by using the string from the <code>nlrx_id</code> field (which contains the current experiment name, siminputrow and random seed divided by an underscore) and add the current tick (containing leading zeros by adding 1000 to the tick count and removing the first number afterwards).</p>
<p>Of course you could also use different approaches to utilize the information within the <code>nlrx_id</code> field for tagging your output.</p>
</div>
<div id="step-4-linking-self-written-output-to-nlrx-collected-output" class="section level4">
<h4 class="hasAnchor">
<a href="#step-4-linking-self-written-output-to-nlrx-collected-output" class="anchor"></a>Step 4: Linking self-written output to nlrx collected output</h4>
<p>Finally, we want to read in our self-written raster files, calculate some landscape metrics and add those to the results table that we received from the <code><a href="../../reference/run_nl_all.html">run_nl_all()</a></code> function.</p>
<p>We basically have two types of output now: The tibble from our model executions, and a folder with self-written output (here defined as a subfolder of our modelpath).</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co">## Output from nlrx simulations:</span>
<span class="no">results</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/run_nl_all.html">run_nl_all</a></span>(<span class="no">nl</span>)
<span class="co">## Self-writte output directory:</span>
<span class="no">ascdir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span>(<span class="no">nl</span>@<span class="kw">modelpath</span>), <span class="st">"output"</span>)</pre></body></html></div>
<p>We can now loop over the files in that folder, read the content and use the <code>strplit</code> function on the filename to identify the experiment name, the siminputrow, the random seed and the tick count. As an example application, we then calculate some landscapemetrics using the <code>landscapemetrics</code> package. Finally we put everything into a results tibble:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">results.lsm</span> <span class="kw">&lt;-</span> <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="no">ascdir</span>, <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"asc"</span>, <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>), <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="no">x.split</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">x</span>, <span class="st">"_"</span>)<span class="kw">[[</span><span class="fl">1</span>]]
  <span class="no">x.tick</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">x.split</span><span class="kw">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x.split</span>)]], <span class="st">"\\."</span>)<span class="kw">[[</span><span class="fl">1</span>]]<span class="kw">[[</span><span class="fl">1</span>]])
  <span class="no">x.siminputrow</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">x.split</span><span class="kw">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x.split</span>) - <span class="fl">1</span>]]<span class="kw">[[</span><span class="fl">1</span>]])
  <span class="no">x.seed</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">x.split</span><span class="kw">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">x.split</span>) - <span class="fl">2</span>]]<span class="kw">[[</span><span class="fl">1</span>]])
  <span class="no">x.raster</span> <span class="kw">&lt;-</span> <span class="fu">raster</span>(<span class="no">x</span>)

  <span class="co">## netlogo asc files use NaN as default nodata value in the asc file header</span>
  <span class="co">## this leads to problems when reading the raster because it sets ´zeros to NA</span>
  <span class="co">## here we set NAs back to zertos manually:</span>
  <span class="no">x.raster</span> <span class="kw">&lt;-</span> <span class="fu">reclassify</span>(<span class="no">x.raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fl">NA</span>, <span class="fl">0</span>))

  <span class="co">## Calculate landscape metrics:</span>
  <span class="no">metrics</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"lsm_l_ed"</span>, <span class="st">"lsm_l_shdi"</span>, <span class="st">"lsm_l_lsi"</span>, <span class="st">"lsm_l_lpi"</span>, <span class="st">"lsm_l_area_mn"</span>)
  <span class="no">x.metrics</span> <span class="kw">&lt;-</span> <span class="kw pkg">landscapemetrics</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/landscapemetrics/man/calculate_lsm.html">calculate_lsm</a></span>(<span class="no">x.raster</span>, <span class="kw">what</span><span class="kw">=</span><span class="no">metrics</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">metric</span>, <span class="no">value</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">tidyr</span><span class="kw ns">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span>(<span class="kw">names_from</span><span class="kw">=</span><span class="no">metric</span>, <span class="kw">values_from</span> <span class="kw">=</span> <span class="no">value</span>)

  <span class="no">x.final</span> <span class="kw">&lt;-</span> <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(<span class="kw">siminputrow</span> <span class="kw">=</span> <span class="no">x.siminputrow</span>,
                            <span class="kw">`[step]`</span> <span class="kw">=</span> <span class="no">x.tick</span>,
                            <span class="kw">`random-seed`</span> <span class="kw">=</span> <span class="no">x.seed</span>)

  <span class="no">x.final</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">x.final</span>, <span class="no">x.metrics</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x.final</span>)
})</pre></body></html></div>
<p>Now we have the same identifier columns in the nlrx reported output and the self-written output tibble which allows us to join both tibbles together:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co">## Combine results with lsm and store:</span>
<span class="no">results</span> <span class="kw">&lt;-</span> <span class="no">results</span> <span class="kw">%&gt;%</span> <span class="fu">left_join</span>(<span class="no">results.lsm</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"siminputrow"</span>, <span class="st">"random-seed"</span>, <span class="st">"[step]"</span>))

<span class="co">## Attach output to nl object:</span>
<span class="fu"><a href="../../reference/setsim.html">setsim</a></span>(<span class="no">nl</span>, <span class="st">"simoutput"</span>) <span class="kw">&lt;-</span> <span class="no">results</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">nl</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">outpath</span>, <span class="st">"my_final_nl_object.rds"</span>))</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jan Salecker, Marco Sciaini.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
